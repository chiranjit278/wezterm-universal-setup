name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release and Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@telagod'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## üöÄ WezTerm Universal Setup ${{ steps.version.outputs.VERSION }}

            ‰∏ÄÈîÆÈÖçÁΩÆÊÇ®ÁöÑ WezTerm ÁªàÁ´ØÁæéÂåñÊñπÊ°àÔºåÊîØÊåÅËá™Âä®Ê£ÄÊµãÂ§öÁßç Shell ÁéØÂ¢ÉÔºÅ

            ### üì¶ ÂÆâË£ÖÊñπÂºè

            #### ÊñπÂºè 1: NPXÔºàGitHub PackagesÔºâ

            È¶ñÂÖàÈÖçÁΩÆ GitHub Packages ËÆ§ËØÅÔºö
            ```bash
            # ÂàõÂª∫ GitHub Personal Access Token (read:packages)
            # ËÆøÈóÆ: https://github.com/settings/tokens

            # ÈÖçÁΩÆ npm
            npm config set @telagod:registry https://npm.pkg.github.com
            npm config set //npm.pkg.github.com/:_authToken YOUR_TOKEN

            # ‰ΩøÁî® npx ÂÆâË£Ö
            npx @telagod/wezterm-universal-setup
            ```

            #### ÊñπÂºè 2: curl/wgetÔºàÊé®ËçêÔºåÊó†ÈúÄËÆ§ËØÅÔºâ

            **Unix/Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash

            # Êàñ‰ΩøÁî® wget
            wget -qO- https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            **Windows:**
            ```powershell
            iwr -useb https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1 | iex
            ```

            #### ÊñπÂºè 3: Êú¨Âú∞ÂÆâË£Ö

            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd wezterm-universal-setup
            ./install.sh  # Êàñ .\install.ps1 (Windows)
            ```

            ### ‚ú® ‰∏ªË¶ÅÁâπÊÄß

            - üîç **Ëá™Âä®Ê£ÄÊµã** Á≥ªÁªü‰∏≠ÊâÄÊúâÂèØÁî®ÁöÑ ShellÔºàBash, Zsh, Fish, PowerShell Á≠âÔºâ
            - üåê **Ë∑®Âπ≥Âè∞ÊîØÊåÅ** Linux, macOS, Windows
            - üé® **ÁæéÂåñ CLI** ÂΩ©Ëâ≤ËæìÂá∫„ÄÅÂõæÊ†á„ÄÅÂä†ËΩΩÂä®Áîª
            - üì¶ **Â§öÁßçÂÆâË£ÖÊñπÂºè** NPX, curl, wget, PowerShell, Êú¨Âú∞ÂÆâË£Ö
            - üîß **Èõ∂ÈÖçÁΩÆ** ÂºÄÁÆ±Âç≥Áî®ÔºåËá™Âä®ÈÄâÊã©ÊúÄ‰Ω≥ Shell
            - üíæ **ÂÆâÂÖ®Â§á‰ªΩ** Ëá™Âä®Â§á‰ªΩÁé∞ÊúâÈÖçÁΩÆ

            ### üìö ÊñáÊ°£

            - [ÂÆåÊï¥ÊñáÊ°£](https://github.com/${{ github.repository }})
            - [Êõ¥Êñ∞Êó•Âøó](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            - [ÂÆâË£ÖÊåáÂçó](https://github.com/${{ github.repository }}#-Âø´ÈÄüÂºÄÂßã)
            - [ÊïÖÈöúÊéíÈô§](https://github.com/${{ github.repository }}#-ÊïÖÈöúÊéíÈô§)

            ### üéØ ÊîØÊåÅÁöÑ Shell

            - Bash
            - Zsh
            - Fish
            - PowerShell (Core & Desktop)
            - Nushell
            - Git Bash
            - Command Prompt

            ### üôè Ëá¥Ë∞¢

            Âü∫‰∫é [KevinSilvester/wezterm-config](https://github.com/KevinSilvester/wezterm-config) ÁöÑ‰ºòÁßÄÈÖçÁΩÆ

            ---

            Made with ‚ù§Ô∏è by KOOI
          draft: false
          prerelease: false

      - name: Publish to GitHub Packages
        run: |
          echo "üì¶ Publishing to GitHub Packages..."
          echo "//npm.pkg.github.com/:_authToken=$NODE_AUTH_TOKEN" >> ~/.npmrc
          npm publish
          echo "‚úÖ Published successfully!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify publication
        run: |
          echo "üîç Verifying package publication..."
          sleep 5
          gh api /users/${{ github.repository_owner }}/packages/npm/wezterm-universal-setup || echo "Package info will be available shortly"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
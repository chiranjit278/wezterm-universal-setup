name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release and Publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@telagod'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ğŸš€ WezTerm Universal Setup ${{ steps.version.outputs.VERSION }}

            ä¸€é”®é…ç½®æ‚¨çš„ WezTerm ç»ˆç«¯ç¾åŒ–æ–¹æ¡ˆï¼Œæ”¯æŒè‡ªåŠ¨æ£€æµ‹å¤šç§ Shell ç¯å¢ƒï¼

            ### ğŸ“¦ å®‰è£…æ–¹å¼

            #### æ–¹å¼ 1: NPXï¼ˆGitHub Packagesï¼‰

            é¦–å…ˆé…ç½® GitHub Packages è®¤è¯ï¼š
            ```bash
            # åˆ›å»º GitHub Personal Access Token (read:packages)
            # è®¿é—®: https://github.com/settings/tokens

            # é…ç½® npm
            npm config set @telagod:registry https://npm.pkg.github.com
            npm config set //npm.pkg.github.com/:_authToken YOUR_TOKEN

            # ä½¿ç”¨ npx å®‰è£…
            npx @telagod/wezterm-universal-setup
            ```

            #### æ–¹å¼ 2: curl/wgetï¼ˆæ¨èï¼Œæ— éœ€è®¤è¯ï¼‰

            **Unix/Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash

            # æˆ–ä½¿ç”¨ wget
            wget -qO- https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            **Windows:**
            ```powershell
            iwr -useb https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1 | iex
            ```

            #### æ–¹å¼ 3: æœ¬åœ°å®‰è£…

            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd wezterm-universal-setup
            ./install.sh  # æˆ– .\install.ps1 (Windows)
            ```

            ### âœ¨ ä¸»è¦ç‰¹æ€§

            - ğŸ” **è‡ªåŠ¨æ£€æµ‹** ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„ Shellï¼ˆBash, Zsh, Fish, PowerShell ç­‰ï¼‰
            - ğŸŒ **è·¨å¹³å°æ”¯æŒ** Linux, macOS, Windows
            - ğŸ¨ **ç¾åŒ– CLI** å½©è‰²è¾“å‡ºã€å›¾æ ‡ã€åŠ è½½åŠ¨ç”»
            - ğŸ“¦ **å¤šç§å®‰è£…æ–¹å¼** NPX, curl, wget, PowerShell, æœ¬åœ°å®‰è£…
            - ğŸ”§ **é›¶é…ç½®** å¼€ç®±å³ç”¨ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³ Shell
            - ğŸ’¾ **å®‰å…¨å¤‡ä»½** è‡ªåŠ¨å¤‡ä»½ç°æœ‰é…ç½®

            ### ğŸ“š æ–‡æ¡£

            - [å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }})
            - [æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            - [å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}#-å¿«é€Ÿå¼€å§‹)
            - [æ•…éšœæ’é™¤](https://github.com/${{ github.repository }}#-æ•…éšœæ’é™¤)

            ### ğŸ¯ æ”¯æŒçš„ Shell

            - Bash
            - Zsh
            - Fish
            - PowerShell (Core & Desktop)
            - Nushell
            - Git Bash
            - Command Prompt

            ### ğŸ™ è‡´è°¢

            åŸºäº [KevinSilvester/wezterm-config](https://github.com/KevinSilvester/wezterm-config) çš„ä¼˜ç§€é…ç½®

            ---

            Made with â¤ï¸ by KOOI
          draft: false
          prerelease: false

      - name: Configure npm authentication
        run: |
          echo "@telagod:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Publish to GitHub Packages
        run: |
          echo "ğŸ“¦ Publishing to GitHub Packages..."
          npm publish
          echo "âœ… Published successfully!"

      - name: Verify publication
        run: |
          echo "ğŸ” Verifying package publication..."
          sleep 5
          gh api /users/${{ github.repository_owner }}/packages/npm/wezterm-universal-setup || echo "Package info will be available shortly"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}